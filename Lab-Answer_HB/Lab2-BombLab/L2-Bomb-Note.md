# Lab2:BombLab Note

æç¤º: æœ¬æ–‡å¯èƒ½ç›´æ¥åŒ…å«ç­”æ¡ˆ, å¦‚æœä½ æƒ³è‡ªå·±è§£å†³,ä¸å»ºè®®ä½¿ç”¨æœ¬æ–‡.

## Catalog

1. GDB	åŒ…æ‹¬GDBåŸºæœ¬ä½¿ç”¨æ³•, ä½†ä¸å…¨é¢
2. Bombs  åŒ…æ‹¬å„ç‚¸å¼¹çš„é¢˜è§£ä¸ç­”æ¡ˆ
3. Functions    åŒ…æ‹¬å„å‡½æ•°åŠå…¶å—è°ƒç”¨å‡½æ•°çš„åæ±‡ç¼–,åŠè§£é‡Š

## GDB

### Breakpoints

```
 break sum					è¿›å…¥sum()æ—¶æ–­ç‚¹
 break *0x80483c3 			åœ¨åœ°å€ 0x80483c3 è®¾ç½®æ–­ç‚¹(æ³¨æ„`\*å·)
```



### Execution

```
stepi n						æ‰§è¡Œnæ¡æŒ‡ä»¤,ç¼ºçœä¸º1 ä¼šè¿›å…¥è¢«è°ƒç”¨å‡½æ•°
nexti n						æ‰§è¡Œnæ¡æŒ‡ä»¤,ç¼ºçœä¸º1 ä¸ä¼šè¿›å…¥è¢«è°ƒç”¨å‡½æ•°
```



### Print

```
print (char *) 0xbfff890   	Examine a string stored at 0xbffff890

print  /x $rip         		åå…­è¿›åˆ¶æ‰“å°ripå¯„å­˜å™¨ (/xå¯æ¢ä¸º/dæˆ–/b)

print *(int *) 0xbffff890 	Print integer at address 0xbffff890

print *(int **) ($rsp+8)	Print address at address  ($rsp+8)

```

### Info



```
 info registers     	Print all registers and their contents 

info breakpoints  		Print status of user-settable breakpoints
```



## Bombs

### Bomb1

ç‚¸å¼¹1æ¶‰åŠåˆ°ä»¥ä¸‹å‡½æ•°:

1. Phase_1
2. strings_not_equal
3. string_length

è¾“å…¥ä¸€ä¸ªå­—ç¬¦ä¸², å®ƒå°†ä¸ä½äºåœ°å€`0x402400`çš„å­—ç¬¦ä¸²æ¯”è¾ƒ, ç›¸ç¬¦å³å¯æ‹†é™¤.

å› æ­¤ç­”æ¡ˆä¸º:

> Border relations with Canada have never been better.


### Bomb2

ç‚¸å¼¹2æ¶‰åŠåˆ°ä»¥ä¸‹å‡½æ•°:

1. Phase_2
2. read_six_numbers

è¾“å…¥6ä¸ªæ•°å­—, ç¬¬ä¸€ä¸ªæ˜¯1, å‰©ä¸‹æˆå…¬æ¯”ä¸º2çš„G.P. å³å¯æ‹†é™¤.

å› æ­¤ç­”æ¡ˆä¸º:

> 1 2 4 8 16 32

 

### Bomb3

ç‚¸å¼¹3æ¶‰åŠåˆ°ä»¥ä¸‹å‡½æ•°:

1. phase_3
2. __isoc99_sscanf

è¾“å…¥ä¸¤ä¸ªæ•°å­—, è¿™ä¸¤ä¸ªæ•°å­—å¿…é¡»æ˜¯ä»¥ä¸‹8ç»„ä¹‹ä¸€:

- 0    207
- 1    311
- 2    707
- 3    256
- 4    389
- 5    206
- 6    682
- 7    327

ä¾‹å¦‚,ç­”æ¡ˆå¯ä»¥è¾“å…¥:

> 2   707

ç­”æ¡ˆä¸å”¯ä¸€

### Bomb4

è¿™ä¸ªé€’å½’ç‚¸å¼¹çœŸæŠŠæˆ‘æ•´ğŸ¤®äº†... æ¯ä¸€æ¡æ±‡ç¼–æŒ‡ä»¤éƒ½èƒ½çœ‹æ‡‚åœ¨å¹²ä»€ä¹ˆ, åˆåœ¨ä¸€èµ·å°±å‚»äº†, è¿çŒœå¸¦è’™æŠŠç­”æ¡ˆé¼“æ£å‡ºæ¥äº†...

æˆ‘è®¨åŒé€’å½’ğŸ˜­

PS: åæ¥ç”¨åæ±‡ç¼–è§£å†³äº†

ç‚¸å¼¹4æ¶‰åŠåˆ°ä»¥ä¸‹å‡½æ•°:

1. phase_4
2. func4

è¾“å…¥ä¸¤ä¸ªæ•°å­—, æ•°å­—1å¿…é¡»ä¸º `{0,1,3,7}` ä¸­ä»»ä¸€ä¸ª, æ•°å­—2å¿…é¡»ä¸º `0`.

ä¾‹å¦‚, ç­”æ¡ˆå¯ä»¥è¾“å…¥:

> 3  0

ç­”æ¡ˆä¸å”¯ä¸€

## Functions

### Main()

```

```

---

### Phase_1

- è¾“å…¥: ä¸€ä¸ªå­—ç¬¦æŒ‡é’ˆ input
- åŠŸèƒ½: input æŒ‡å‘å¯¹è±¡ä¸ åœ°å€`$0x402400`æŒ‡å‘å¯¹è±¡ç›¸åŒ,ä¸åŒç‚¸
- è°ƒç”¨: strings_not_equal();  explode_bomb();
- è¿”å›: 0

```
Dump of assembler code for function phase_1:
//rdi = *input
    0x0000000000400ee0 <+0>:	sub    $0x8,%rsp        //æ ˆä¸‹è°ƒ8ä½
    0x0000000000400ee4 <+4>:	mov    $0x402400,%esi   //$0x402400 æ”¾å…¥%esi(å‚æ•°2)
    0x0000000000400ee9 <+9>:	callq  0x401338 <strings_not_equal> //è°ƒç”¨strings_not_equal
    0x0000000000400eee <+14>:	test   %eax,%eax       //æ£€æµ‹å‚1å‚2æ˜¯å¦ç›¸åŒ
    0x0000000000400ef0 <+16>:	je     0x400ef7 <phase_1+23>    //0ç›¸åŒ è½¬+23
    0x0000000000400ef2 <+18>:	callq  0x40143a <explode_bomb>  //1ä¸åŒ,ç‚¸
    0x0000000000400ef7 <+23>:	add    $0x8,%rsp    //å‡ºæ ˆ
    0x0000000000400efb <+27>:	retq 

```



### strings_not_equal

- è¾“å…¥: å‚æ•°12 å‡ä¸ºå­—ç¬¦åœ°å€
- åŠŸèƒ½: æ¯”è¾ƒä¸¤ä¸ªæŒ‡å‘å¯¹è±¡é•¿åº¦ä¸å†…å®¹æ˜¯å¦ç›¸åŒ
- è°ƒç”¨: string_length()
- è¿”å›: ç›¸åŒè¿”å›0, ä¸åŒè¿”å›1

```
Dump of assembler code for function strings_not_equal:
/* rdi = *input; esi = $0x402400
    0x0000000000401338 <+0>:	push   %r12
    0x000000000040133a <+2>:	push   %rbp
    0x000000000040133b <+3>:	push   %rbx     //ä»¥ä¸Šä¿å­˜ç¯å¢ƒ
    0x000000000040133c <+4>:	mov    %rdi,%rbx    //rbx = *input
    0x000000000040133f <+7>:	mov    %rsi,%rbp    //rbp = $0x402400(åœ°å€)
    0x0000000000401342 <+10>:	callq  0x40131b <string_length> //è°ƒç”¨string_length, å‚æ•°ä¸å˜
    0x0000000000401347 <+15>:	mov    %eax,%r12d   //r12d(åŒå­—)ä¿å­˜å­—ç¬¦ä¸²é•¿åº¦
    0x000000000040134a <+18>:	mov    %rbp,%rdi    //è®¡ç®—($0x402400)çš„é•¿åº¦
    0x000000000040134d <+21>:	callq  0x40131b <string_length> //($0x402400)é•¿åº¦ä¿å­˜åœ¨rax
    0x0000000000401352 <+26>:	mov    $0x1,%edx    //edx = 1
    0x0000000000401357 <+31>:	cmp    %eax,%r12d   //å­—ç¬¦ä¸²ä¸å¸¸æ•°é•¿åº¦æ¯”è¾ƒ
    0x000000000040135a <+34>:	jne    0x40139b <strings_not_equal+99>  //é•¿åº¦ä¸åŒè½¬99
    0x000000000040135c <+36>:	movzbl (%rbx),%eax  //ä¸²1 -> rax
    0x000000000040135f <+39>:	test   %al,%al
    0x0000000000401361 <+41>:	je     0x401388 <strings_not_equal+80>//å¦‚æœä¸²1ç©º,è½¬80
    0x0000000000401363 <+43>:	cmp    0x0(%rbp),%al        //æ¯”è¾ƒä¸²1ä¸²2
    0x0000000000401366 <+46>:	je     0x401372 <strings_not_equal+58>  //ç›¸ç­‰,è½¬58
    0x0000000000401368 <+48>:	jmp    0x40138f <strings_not_equal+87>  //ä¸ç­‰,è½¬87
    0x000000000040136a <+50>:	cmp    0x0(%rbp),%al    //æ¯”è¾ƒ(å¸¸æ•°)ä¸å­—ç¬¦ä¸²
    0x000000000040136d <+53>:	nopl   (%rax)       //å¥½åƒæ˜¯å¯¹é½ç”¨çš„? æ— æ“ä½œ
    0x0000000000401370 <+56>:	jne    0x401396 <strings_not_equal+94>  //ä¸ç­‰è½¬94
    0x0000000000401372 <+58>:	add    $0x1,%rbx    //å­—ç¬¦ä¸²æŒ‡é’ˆ++
    0x0000000000401376 <+62>:	add    $0x1,%rbp    //å¸¸æ•°åœ°å€æŒ‡é’ˆ++
    0x000000000040137a <+66>:	movzbl (%rbx),%eax  
    0x000000000040137d <+69>:	test   %al,%al      //å¦‚æœå­—ç¬¦ä¸²ä¸ç©º
    0x000000000040137f <+71>:	jne    0x40136a <strings_not_equal+50> //è½¬+50
    0x0000000000401381 <+73>:	mov    $0x0,%edx	//å¦‚æœä¸²1ç©º
    0x0000000000401386 <+78>:	jmp    0x40139b <strings_not_equal+99>
    0x0000000000401388 <+80>:	mov    $0x0,%edx	//ä¸Šæ¥41,ä¸²1ç©º, è¿”å›0
    0x000000000040138d <+85>:	jmp    0x40139b <strings_not_equal+99>
    0x000000000040138f <+87>:	mov    $0x1,%edx    //ä¸Šæ¥48,ä¸²12ä¸ç­‰,è¿”å›1
    0x0000000000401394 <+92>:	jmp    0x40139b <strings_not_equal+99>
    0x0000000000401396 <+94>:	mov    $0x1,%edx    //ä¸Šæ¥94,ä¸²ä¸ç­‰,è¿”å›1
    0x000000000040139b <+99>:	mov    %edx,%eax    //ä¸Šæ¥34,é•¿åº¦ä¸ç­‰,è¿”å›1
    0x000000000040139d <+101>:	pop    %rbx 
    0x000000000040139e <+102>:	pop    %rbp
    0x000000000040139f <+103>:	pop    %r12 //æ¢å¤ç¯å¢ƒ
    0x00000000004013a1 <+105>:	retq   

```

æ³¨:

1. å¼€å¤´ç»“å°¾æœ‰ä¿å­˜ç¯å¢ƒçš„pushä¸popæ“ä½œ

2. r12d æŒ‡12å¯„å­˜å™¨çš„åŒå­—éƒ¨åˆ†, ä¾æ¬¡æ˜¯:r12, r12d, r12w, r12b. dç–‘ä¼¼æŒ‡double word

3. nopl ä¸ºæ— æ“ä½œ, å¯å‚è€ƒ[è¿™é‡Œ](https://exp.newsmth.net/topic/article/9a37ce02c405b2b7ae9558f161f38c38).

4. è¿‡ç¨‹:

   1. å…ˆæ¯”è¾ƒä¸¤ä¸²çš„é•¿åº¦,è‹¥ä¸åŒç›´æ¥è¿”å›1(+34); 
   2. ç„¶åä¸€ä¸ªä¸€ä¸ªbitåœ°æ¯”è¾ƒ, æ¯æ¬¡æ¯”è¾ƒå®Œè·³è½¬å›+50, ç›´åˆ°å…¨éƒ¨æ¯”è¾ƒç»“æŸ, ä¸²ä¸ºç©º,è¿”å›0
   3. å½“æ¯”è¾ƒä¸­é‡åˆ°ä¸²ä¸ç­‰, ç«‹åˆ»é€€å‡º,è¿”å›1

5. ç–‘æƒ‘:

   1. ä¸ºä»€ä¹ˆæ¯æ¬¡æŒ‡é’ˆä»…ä»…æ˜¯è‡ªåŠ ? æ¯æ¬¡æ˜¯å¯¹alæ¯”è¾ƒ(1byte), æŒ‡é’ˆ+4å²‚ä¸ç¾å“‰?

   2. 87,94,99éƒ½æ˜¯å‡ºé”™, è¿”å›1, ä¸ºä»€ä¹ˆä¸åˆå¹¶æˆ1ä¸ª? 

      (çŒœæµ‹:å¯èƒ½æ˜¯ä¼˜åŒ–çº§åˆ«ä¸å¤Ÿ, ç…§é¡¾æˆ‘ä»¬çš„æ™ºåŠ›æ°´å¹³ğŸ˜‚)



### string_length

- è¾“å…¥: å­—ç¬¦æŒ‡é’ˆ
- åŠŸèƒ½: è¿”å›æŒ‡å‘çš„ä¸²çš„é•¿åº¦, ç©ºè¿”å›0
- æ— è°ƒç”¨
- è¿”å›: è¿”å›æŒ‡å‘çš„ä¸²çš„é•¿åº¦, ç©ºè¿”å›0

```
rdi = *input; 
Dump of assembler code for function string_length:
    0x000000000040131b <+0>:	cmpb   $0x0,(%rdi)      
    0x000000000040131e <+3>:	je     0x401332 <string_length+23>  //å¦‚æœinputç©º, è½¬23(è¿”å›0)
    0x0000000000401320 <+5>:	mov    %rdi,%rdx        //rdx = *input
    0x0000000000401323 <+8>:	add    $0x1,%rdx        //rdx ++ æ¯è½®å°†æŒ‡é’ˆ+1 
    0x0000000000401327 <+12>:	mov    %edx,%eax    //eax =rdx
    0x0000000000401329 <+14>:	sub    %edi,%eax    //eax -= edi, å½“å‰æŒ‡é’ˆä¸åŸæŒ‡é’ˆå·®å€¼
    0x000000000040132b <+16>:	cmpb   $0x0,(%rdx)  //æŒ‡é’ˆæŒ‡å‘ä¸0æ¯”è¾ƒ
    0x000000000040132e <+19>:	jne    0x401323 <string_length+8>//å½“æŒ‡å‘éé›¶, è¡¨ç¤ºè¿˜æœªç»“æŸ é€’å½’è°ƒç”¨
    0x0000000000401330 <+21>:	repz retq   //è¿”è¿˜rax å³æœ€åçš„å·®å€¼, ä¸ºæŒ‡é’ˆå‚¨å­˜çš„æ•°æ®çš„é•¿åº¦
    0x0000000000401332 <+23>:	mov    $0x0,%eax    //(ä¸Šæ¥+3) è¿”å›0
    0x0000000000401337 <+28>:	retq  
```



---

### Phase_2

- è¾“å…¥: *input
- åŠŸèƒ½: ä¸å…­ä¸ªæ•°å­—æ¯”è¾ƒ, ä¸åŒç‚¸
- è°ƒç”¨: read_six_numbers
- è¿”å›: æ— 

```
Dump of assembler code for function phase_2:
//rdi *input
    0x0000000000400efc <+0>:	push   %rbp
    0x0000000000400efd <+1>:	push   %rbx			//ä¿å­˜ç¯å¢ƒ
    0x0000000000400efe <+2>:	sub    $0x28,%rsp   //æ ˆåˆ†28ä½
    0x0000000000400f02 <+6>:	mov    %rsp,%rsi    //æ ˆæŒ‡é’ˆä½œä¸ºç¬¬äºŒä¸ªå‚æ•°
    0x0000000000400f05 <+9>:	callq  0x40145c <read_six_numbers>	//è¯»æ•°åœ¨æ ˆå†…
    0x0000000000400f0a <+14>:	cmpl   $0x1,(%rsp)  //æ ˆé¡¶å…ƒç´ ä¸1æ¯”è¾ƒ
    0x0000000000400f0e <+18>:	je     0x400f30 <phase_2+52>    //ä¸åŒç‚¸, ç›¸åŒè½¬52
    0x0000000000400f10 <+20>:	callq  0x40143a <explode_bomb>
    0x0000000000400f15 <+25>:	jmp    0x400f30 <phase_2+52>
    0x0000000000400f17 <+27>:	mov    -0x4(%rbx),%eax      //eax = æ ˆå…ƒç´ å‰ä¸€ä¸ªå…ƒç´ 
    0x0000000000400f1a <+30>:	add    %eax,%eax            //eax *= 2
    0x0000000000400f1c <+32>:	cmp    %eax,(%rbx)              //rbx(ä¸‹ä¸€ä¸ªå…ƒç´ )ä¸eax(ä¸¤å€çš„ä¸Šä¸€ä¸ªå…ƒç´ )æ¯”è¾ƒ
    0x0000000000400f1e <+34>:	je     0x400f25 <phase_2+41>    //ä¸åŒç‚¸,ç›¸åŒè½¬41
    0x0000000000400f20 <+36>:	callq  0x40143a <explode_bomb>
    0x0000000000400f25 <+41>:	add    $0x4,%rbx            //rbx = æ ˆä¸‹ä¸€ä¸ªå…ƒç´ 
    0x0000000000400f29 <+45>:	cmp    %rbp,%rbx            //rbx ä¸ rbpæ¯”è¾ƒ
    0x0000000000400f2c <+48>:	jne    0x400f17 <phase_2+27>    //ä¸åŒè½¬27,ç»§ç»­è½®å›
    0x0000000000400f2e <+50>:	jmp    0x400f3c <phase_2+64>//ç›¸åŒ,ç¬¬å…­ä¸ªå…ƒç´  è½¬64
    0x0000000000400f30 <+52>:	lea    0x4(%rsp),%rbx       //rbx = ä¸‹ä¸€ä¸ªå…ƒç´ 
    0x0000000000400f35 <+57>:	lea    0x18(%rsp),%rbp      //rbp = æ ˆé¡¶+18(åº”è¯¥æ˜¯ç¬¬å…­ä¸ªå…ƒç´ ,å­˜ç–‘)
    0x0000000000400f3a <+62>:	jmp    0x400f17 <phase_2+27>   //è½¬27
    0x0000000000400f3c <+64>:	add    $0x28,%rsp           //å‡ºæ ˆ28ä½
    0x0000000000400f40 <+68>:	pop    %rbx
    0x0000000000400f41 <+69>:	pop    %rbp             //æ¢å¤ç¯å¢ƒ
    0x0000000000400f42 <+70>:	retq                    //ç»“æŸ
```

æ³¨: 

1. read_six_numbers å‡½æ•°å†…å…¶å®æ²¡çœ‹æ‡‚, ç”±åå­—çŒœæµ‹äº†ä¸€æ³¢
2. lea S DæŒ‡ä»¤, å°†S(ä¸€ä¸ªæœ‰æ•ˆåœ°å€) å¤åˆ¶ç»™D, åç»­å¼•ç”¨(D)ç”¨æ³•ç±»ä¼¼æŒ‡é’ˆ
3. `add    $0x4,%rbx` æŒ‡é’ˆä¸‹ä¸€ä¸ªå…ƒç´ , æ³¨æ„æ ˆæ˜¯å€’è¿‡æ¥å‚¨å­˜çš„
4. å­˜ç–‘:
   1. 57 è¡Œ, `%rbp`åº”è¯¥æ˜¯è¢«èµ‹äº†ç¬¬å…­ä¸ªå‚æ•°çš„å€¼. å¯æ˜¯ä¸ºä»€ä¹ˆæ˜¯+18? ä¸åº”è¯¥æ˜¯+ 20(4*5)å—?



### read_six_numbers

- è¾“å…¥: *input, æ ˆæŒ‡é’ˆ
- åŠŸèƒ½: è¯»å–6ä¸ªæ•°æ®å‚¨å­˜åœ¨æ ˆä¸­
- è°ƒç”¨: __isoc99_sscanf@plt (ç–‘ä¼¼åº“å‡½æ•°?)
- è¿”å›: æ— 

```
Dump of assembler code for function read_six_numbers:
    //rdi *input    rsi æ ˆæŒ‡é’ˆ
    0x000000000040145c <+0>:	sub    $0x18,%rsp       //åˆ†é…18
    0x0000000000401460 <+4>:	mov    %rsi,%rdx        //rdx = åŸæ ˆæŒ‡é’ˆ
    0x0000000000401463 <+7>:	lea    0x4(%rsi),%rcx   //rcx = (åŸæ ˆ2)
    0x0000000000401467 <+11>:	lea    0x14(%rsi),%rax  //rax = (åŸæ ˆ+14)
    0x000000000040146b <+15>:	mov    %rax,0x8(%rsp)   //(æ ˆ+8) = åŸæ ˆ+14
    0x0000000000401470 <+20>:	lea    0x10(%rsi),%rax  //rax = (åŸæ ˆ+10)
    0x0000000000401474 <+24>:	mov    %rax,(%rsp)      //(rsp) = rax = (åŸæ ˆ+10)
    0x0000000000401478 <+28>:	lea    0xc(%rsi),%r9    //r9 = (rsi+c)
    0x000000000040147c <+32>:	lea    0x8(%rsi),%r8    //r8 = (rsi+8)
    0x0000000000401480 <+36>:	mov    $0x4025c3,%esi   //si = $0x4025c3
    0x0000000000401485 <+41>:	mov    $0x0,%eax        //ax = 0
    0x000000000040148a <+46>:	callq  0x400bf0 <__isoc99_sscanf@plt>
    0x000000000040148f <+51>:	cmp    $0x5,%eax        //ç»“æœä¸5æ¯”è¾ƒ
    0x0000000000401492 <+54>:	jg     0x401499 <read_six_numbers+61>//ç»“æœ>5 ä¸ç‚¸
    0x0000000000401494 <+56>:	callq  0x40143a <explode_bomb>
    0x0000000000401499 <+61>:	add    $0x18,%rsp       //æ”¶å›18
    0x000000000040149d <+65>:	retq 
```

å—¯...è™½ç„¶æˆ‘æ²¡æ‡‚ä»–æ¯ä¸€æ­¥åœ¨å¹²ä»€ä¹ˆ, ä¸å¦¨ç¢æˆ‘çŒœå‡ºä»–æ˜¯ç”¨æ¥å¹²å•¥çš„.

### Phase_3

- è¾“å…¥: *input
- åŠŸèƒ½: ä¸ä¸¤ä¸ªæ•°å­—æ¯”è¾ƒ, ä¸åŒç‚¸
- è°ƒç”¨: __isoc99_sscanf
- è¿”å›: æ— 

```
rdi = &input
Dump of assembler code for function phase_3:
    0x0000000000400f43 <+0>:	    sub    $0x18,%rsp               //æ ˆæ‰©18
    0x0000000000400f47 <+4>:	    lea    0xc(%rsp),%rcx           //rcx = &(æ ˆ12)
    0x0000000000400f4c <+9>:	    lea    0x8(%rsp),%rdx           //rdx = &(æ ˆ8)
    0x0000000000400f51 <+14>:	mov    $0x4025cf,%esi           //si = $0x4025cf
    0x0000000000400f56 <+19>:	mov    $0x0,%eax                //ax = $0x0
    0x0000000000400f5b <+24>:	callq  0x400bf0 <__isoc99_sscanf@plt>   // è§æ³¨è§£p3_1,å°†2ä¸ªæ•°å­—è£…å…¥æ ˆ8 å’Œ æ ˆ12å¤„
    0x0000000000400f60 <+29>:	cmp    $0x1,%eax                //axä¸1æ¯”è¾ƒ 
    0x0000000000400f63 <+32>:	jg     0x400f6a <phase_3+39>    //ax>1 è·³è½¬39 å¦åˆ™ç‚¸
    0x0000000000400f65 <+34>:	callq  0x40143a <explode_bomb>
    0x0000000000400f6a <+39>:	cmpl   $0x7,0x8(%rsp)           //*(æ ˆ8)ä¸7æ¯”è¾ƒ (ä¹Ÿå°±æ˜¯æ•°å­—1ä¸7æ¯”è¾ƒ)
    0x0000000000400f6f <+44>:	ja     0x400fad <phase_3+106>   //*(æ ˆ8)>7(æ— ç¬¦å·) è½¬106,ç‚¸
    0x0000000000400f71 <+46>:	mov    0x8(%rsp),%eax           //ax = *(æ ˆ8) æ•°1
    0x0000000000400f75 <+50>:	jmpq   *0x402470(,%rax,8)       //è·³è½¬åˆ°(ax*8+0x402470) è§æ³¨è§£p3_2
    0x0000000000400f7c <+57>:	mov    $0xcf,%eax               //ä¸Šæ¥50 ä¸”ax=0 key = 0xcf = 207
    0x0000000000400f81 <+62>:	jmp    0x400fbe <phase_3+123>
    0x0000000000400f83 <+64>:	mov    $0x2c3,%eax              //ä¸Šæ¥50 ä¸”ax=2 key = 0x2c3 = 707
    0x0000000000400f88 <+69>:	jmp    0x400fbe <phase_3+123>
    0x0000000000400f8a <+71>:	mov    $0x100,%eax              //ä¸Šæ¥50 ä¸”ax=3 key = 0x100 = 256
    0x0000000000400f8f <+76>:	jmp    0x400fbe <phase_3+123>
    0x0000000000400f91 <+78>:	mov    $0x185,%eax              //ä¸Šæ¥50 ä¸”ax=4 key = 0x185 = 389
    0x0000000000400f96 <+83>:	jmp    0x400fbe <phase_3+123>
    0x0000000000400f98 <+85>:	mov    $0xce,%eax               //ä¸Šæ¥50 ä¸”ax=5 key = 0xce  = 206
    0x0000000000400f9d <+90>:	jmp    0x400fbe <phase_3+123>
    0x0000000000400f9f <+92>:	mov    $0x2aa,%eax              //ä¸Šæ¥50 ä¸”ax=6 key = 0x2aa = 682
    0x0000000000400fa4 <+97>:	jmp    0x400fbe <phase_3+123>
    0x0000000000400fa6 <+99>:	mov    $0x147,%eax              //ä¸Šæ¥50 ä¸”ax=7 key = 0x147 = 327
    0x0000000000400fab <+104>:	jmp    0x400fbe <phase_3+123>
    0x0000000000400fad <+106>:	callq  0x40143a <explode_bomb>  //ä¸Šæ¥44,è¾“å…¥ä¸ªæ•°<2
    0x0000000000400fb2 <+111>:	mov    $0x0,%eax                //è¿™é‡Œæ˜¯ä»€ä¹ˆæƒ…å†µ?å­˜ç–‘
    0x0000000000400fb7 <+116>:	jmp    0x400fbe <phase_3+123>
    0x0000000000400fb9 <+118>:	mov    $0x137,%eax              //ä¸Šæ¥50 ä¸”ax=1 key = 0x137 = 311
    0x0000000000400fbe <+123>:	cmp    0xc(%rsp),%eax           //æ¯”è¾ƒax(å³key)ä¸æ•°2
    0x0000000000400fc2 <+127>:	je     0x400fc9 <phase_3+134>   //ä¸ç­‰ç‚¸
    0x0000000000400fc4 <+129>:	callq  0x40143a <explode_bomb>
    0x0000000000400fc9 <+134>:	add    $0x18,%rsp
    0x0000000000400fcd <+138>:	retq   
```

æ³¨: 

1. è¾“å…¥ä¸¤ä¸ªæ•°å­—,åˆ†åˆ«å‚¨å­˜åœ¨æ ˆ8ä¸æ ˆ12å¤„, å¤šä½™è¾“å…¥ä¸è®¡

2. å¦‚æœè¾“å…¥1ä¸ª,ç›´æ¥ç‚¸

3. æ•°1(æ ˆ8) è‹¥>(unsigned )7, ç›´æ¥ç‚¸

4. æ ¹æ®æ•°1çš„ä¸åŒå–å€¼(0~7), è·³è½¬åˆ°æ ˆç§å‚¨å­˜çš„ä¸åŒåœ°å€, å¹¶æ ¹æ®åœ°å€æ‹¿åˆ°key(å­˜å‚¨åˆ°axä¸­)

5. æ•°2(æ ˆ12) ä¸ keyæ¯”è¾ƒ, ä¸åŒç‚¸, ç›¸åŒè¿‡

6. ç–‘æƒ‘:

   +111å¤„æ˜¯ä»€ä¹ˆæ—¶å€™ä¼šè¿è¡Œåˆ°? ç›´æ¥æŠŠaxèµ‹0?

#### æ³¨è§£p3_1    

**__isoc99_sscanf()**

â€‹    c99æ ‡å‡†åº“sscanfå‡½æ•°, [å‚è€ƒé“¾æ¥](http://www.cplusplus.com/reference/cstdio/sscanf/)

> â€‹    int sscanf ( const char * s, const char * format, ...);
>
> â€‹    Read formatted data from string
>
> â€‹    Reads data from s and stores them according to parameter format into the locations given by the additional arguments, as if scanf was used, but reading from s instead of the standard input (stdin).
>
> â€‹    The additional arguments should point to already allocated objects of the type specified by their corresponding format specifier within the format string.
>
> â€‹    Return Value
>
> â€‹    On success, the function returns the number of items in the argument list successfully filled. This count can match the expected number of items or be less (even zero) in the case of a matching failure.
>
> â€‹    In the case of an input failure before any data could be successfully interpreted, EOF is returned. 

â€‹    è¿”å›è¯»å–åˆ°çš„itemçš„ä¸ªæ•°

#### æ³¨è§£p3_2  

**æ¯ä¸ª(ax*8+0x402470)ä¸­å‚¨å­˜çš„åœ°å€**

```
(gdb) print *(int**)  (0x402470+8*0)
$11 = (int *) 0x400f7c <phase_3+57>

(gdb) print *(int**)  (0x402470+8*1)
$12 = (int *) 0x400fb9 <phase_3+118>

(gdb) print *(int**)  (0x402470+8*2)
$13 = (int *) 0x400f83 <phase_3+64>

(gdb) print *(int**)  (0x402470+8*3)
$14 = (int *) 0x400f8a <phase_3+71>

(gdb) print *(int**)  (0x402470+8*4)
$15 = (int *) 0x400f91 <phase_3+78>

(gdb) print *(int**)  (0x402470+8*5)
$16 = (int *) 0x400f98 <phase_3+85>

(gdb) print *(int**)  (0x402470+8*6)
$17 = (int *) 0x400f9f <phase_3+92>

(gdb) print *(int**)  (0x402470+8*7)
$18 = (int *) 0x400fa6 <phase_3+99>
```



### Phase_4

- è¾“å…¥: *input
- åŠŸèƒ½: ä¸ä¸¤ä¸ªæ•°å­—æ¯”è¾ƒ, ä¸åŒç‚¸
- è°ƒç”¨: __isoc99_sscanf
- è¿”å›: æ— 

```
%rdi &input
Dump of assembler code for function phase_4:
    0x000000000040100c <+0>:	sub    $0x18,%rsp               //æ‰©æ ˆ18
    0x0000000000401010 <+4>:	lea    0xc(%rsp),%rcx           //cx æ ˆ12   æ•°2
    0x0000000000401015 <+9>:	lea    0x8(%rsp),%rdx           //dx æ ˆ8    æ•°1
    0x000000000040101a <+14>:	mov    $0x4025cf,%esi           //si = 0x4025cf
    0x000000000040101f <+19>:	mov    $0x0,%eax                //ax = 0
    0x0000000000401024 <+24>:	callq  0x400bf0 <__isoc99_sscanf@plt>   //è¯»å–
    0x0000000000401029 <+29>:	cmp    $0x2,%eax                //è¯»å…¥2ä¸ªæ•°å­—
    0x000000000040102c <+32>:	jne    0x401035 <phase_4+41>    //è¯»å…¥ä¸ªæ•°!=2,ç‚¸
    0x000000000040102e <+34>:	cmpl   $0xe,0x8(%rsp)           //æ•°1 ä¸ 14æ¯”è¾ƒ
    0x0000000000401033 <+39>:	jbe    0x40103a <phase_4+46>    //æ•°1 <=14 è½¬46
    0x0000000000401035 <+41>:	callq  0x40143a <explode_bomb>  //æ•°1 >14 ç‚¸
    0x000000000040103a <+46>:	mov    $0xe,%edx                //14èµ‹ç»™dx
    0x000000000040103f <+51>:	mov    $0x0,%esi                //si = 0
    0x0000000000401044 <+56>:	mov    0x8(%rsp),%edi           //di æ ˆ8    æ•°1
    0x0000000000401048 <+60>:	callq  0x400fce <func4>         
    0x000000000040104d <+65>:	test   %eax,%eax                //å¯¹äºè¿”å›å€¼ax
    0x000000000040104f <+67>:	jne    0x401058 <phase_4+76>    //ax!=0 è½¬76 ç‚¸
    0x0000000000401051 <+69>:	cmpl   $0x0,0xc(%rsp)           //æ ˆ12(æ•°2) == 0
    0x0000000000401056 <+74>:	je     0x40105d <phase_4+81>    //ä¸ç­‰ç‚¸,ç­‰æ‹†
    0x0000000000401058 <+76>:	callq  0x40143a <explode_bomb>
    0x000000000040105d <+81>:	add    $0x18,%rsp
    0x0000000000401061 <+85>:	retq  
```

æ³¨:

1. è¿™ä¸€å—ä»£ç è¿˜æ˜¯æ¯”è¾ƒå¥½æ‡‚çš„. 0~32ä»inputä¸­å–ä¸¤ä¸ªæ•°å­—æ”¾å…¥æ ˆ8 æ ˆ12 å¤„, å¦‚æœä¸æ˜¯**ä¸¤ä¸ª**æ•°å­—çš„è¯ç›´æ¥ç‚¸
2. 34~67 æ˜¯å¯¹æ•°1 æ£€æµ‹, é¦–å…ˆæ•°1å¿…é¡»<=14, å¦åˆ™ç‚¸. ç„¶åå¯¹æ•°1è°ƒç”¨func4å‡½æ•°, å¦‚æœè¿”å›å€¼!=0ç›´æ¥ç‚¸
3. 69~85 æ˜¯å¯¹æ•°2 æ£€æµ‹, ç®€å•çš„ä»¤äººå‘æŒ‡. ä¸ä¸º0ç‚¸, ä¸º0ç‚¸å¼¹æ‹†é™¤.



### func4

- è¾“å…¥: rdi = æ•°1 rsi = ?   rdx = 0xe
- åŠŸèƒ½: å¯¹å‚æ•°è¿›è¡ŒæŸç§ç¥ç§˜æ“ä½œ, è¿”å›æŸä¸ªå€¼
- è°ƒç”¨:  func4
- è¿”å›: æŸä¸ªint

```
ç¬¬ä¸€è½®: rdi = æ•°1 rsi = 0   rdx = 0xe 
Dump of assembler code for function func4:
   0x0000000000400fce <+0>:	    sub    $0x8,%rsp            //æ ˆæ‰©8
   0x0000000000400fd2 <+4>:	    mov    %edx,%eax            //ax = dx
   0x0000000000400fd4 <+6>:	    sub    %esi,%eax            //ax = dx-si
   0x0000000000400fd6 <+8>:	    mov    %eax,%ecx            //cx = dx-si
   0x0000000000400fd8 <+10>:	shr    $0x1f,%ecx           //é€»è¾‘å³ç§» cx 31ä½ æ­£0è´Ÿ1
   0x0000000000400fdb <+13>:	add    %ecx,%eax            //ax += cx
   0x0000000000400fdd <+15>:	sar    %eax                 //ax ç®—æ•°å³ç§»1ä½
   0x0000000000400fdf <+17>:	lea    (%rax,%rsi,1),%ecx   //cx = si + ax
   0x0000000000400fe2 <+20>:	cmp    %edi,%ecx            //cxä¸æ•°1æ¯”è¾ƒ 
   0x0000000000400fe4 <+22>:	jle    0x400ff2 <func4+36>  //cx<=æ•°1, è½¬36
   0x0000000000400fe6 <+24>:	lea    -0x1(%rcx),%edx      //cx>æ•°1 dx = cx-1
   0x0000000000400fe9 <+27>:	callq  0x400fce <func4>     //è°ƒç”¨func4 di=æ•°1,si=si,dx=cx-1
   0x0000000000400fee <+32>:	add    %eax,%eax            //è¿”å›å€¼ax*=2
   0x0000000000400ff0 <+34>:	jmp    0x401007 <func4+57>  //è¿”å›
   0x0000000000400ff2 <+36>:	mov    $0x0,%eax            //ä¸Šæ¥22 ax = 0
   0x0000000000400ff7 <+41>:	cmp    %edi,%ecx            //æ¯”è¾ƒcx æ•°1
   0x0000000000400ff9 <+43>:	jge    0x401007 <func4+57>  //cx>=æ•°1(ä¹Ÿå°±æ˜¯cx=æ•°1) è½¬57 è¿”å› 
   0x0000000000400ffb <+45>:	lea    0x1(%rcx),%esi       //cx<æ•°1 si = cx+1
   0x0000000000400ffe <+48>:	callq  0x400fce <func4>     //è°ƒç”¨func4 di=æ•°1,si=si=cx+1,dx=dx
   0x0000000000401003 <+53>:	lea    0x1(%rax,%rax,1),%eax    //ax=2ax+1
   0x0000000000401007 <+57>:	add    $0x8,%rsp            
   0x000000000040100b <+61>:	retq 
```



è¿™ä¸ªå‡½æ•°æŠ˜ç£¨äº†æˆ‘æ•´æ•´24h, æœ€ç»ˆæ²¡å¿ä½å»æœäº†åˆ«äººçš„é¢˜è§£. ä¸‹é¢è¿™ä¸€æ®µå€Ÿé‰´äº†[ä¸€ä½ç®€ä¹¦ç½‘å‹çš„è¿™ç¯‡æ–‡ç« ](https://www.jianshu.com/p/33eb51b2024e)

å¯¹func4å‡½æ•°è¿›è¡Œåæ±‡ç¼–:

```c
int fun4(int x, int v2, int v3){
    /*  x = rdi(æ•°1) 
        v2 = rsi(åˆå€¼0)
        v3 = rdx(åˆå€¼e)*/
    int tmp = (v3 - v2) >> 21;    		//é€»è¾‘å³ç§»
    int re = ((v3 - v2) + tmp) >> 1; 	//ç®—æ•°å³ç§»
    tmp = v2 + re;
    if(tmp <= x) {
        if(tmp>=x) return 0;
        re = fun4(x,tmp+1,v3);
        return 2*re+1;
    }
    else{
        re = fun4(x,v2,tmp-1);
        return 2 * re;
    }
}
```

ä¸å¦¨å†å†™ä¸ªæµ‹è¯•å‡½æ•°:

```c
#include <stdio.h>
int main(int argc, char const *argv[])
{
    for (int i = 0; i <= 0xe ; i++)
    {
        if(fun4(i, 0x0, 0xe)==0){
            printf("%d\n",i);
        }
    }
    return 0;
}
```

å¾—åˆ°:

```
0
1
3
7
```

å½“ä¸”ä»…å½“ x = 0,1,3,7 ä¸­æŸä¸ªå€¼æ—¶,funcä¼šè¿”å›0.