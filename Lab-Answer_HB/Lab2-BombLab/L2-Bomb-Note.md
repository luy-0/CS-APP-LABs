# Lab2:BombLab Note

æç¤º: æœ¬æ–‡å¯èƒ½ç›´æ¥åŒ…å«ç­”æ¡ˆ, å¦‚æœä½ æƒ³è‡ªå·±è§£å†³,ä¸å»ºè®®ä½¿ç”¨æœ¬æ–‡.

## Catalog

1. GDB	åŒ…æ‹¬GDBåŸºæœ¬ä½¿ç”¨æ³•, ä½†ä¸å…¨é¢
2. Bombs  åŒ…æ‹¬å„ç‚¸å¼¹çš„é¢˜è§£
3. Functions    åŒ…æ‹¬å„å‡½æ•°åŠå…¶å—è°ƒç”¨å‡½æ•°çš„åæ±‡ç¼–,åŠè§£é‡Š

## GDB

### Breakpoints

 break sum                 		   è¿›å…¥sum()æ—¶æ–­ç‚¹

 break \*0x80483c3          	åœ¨åœ°å€ 0x80483c3 è®¾ç½®æ–­ç‚¹(æ³¨æ„`*`å·)





### print

print (char *) 0xbfff890   Examine a string stored at 0xbffff890

 print  /x $rip             		åå…­è¿›åˆ¶æ‰“å°ripå¯„å­˜å™¨ (/xå¯æ¢ä¸º/dæˆ–/b)



### Info

 info registers            Print all registers and their contents 



## Bombs

### Bomb1

ç‚¸å¼¹1æ¶‰åŠåˆ°ä»¥ä¸‹å‡½æ•°:

1. Phase_1
2. strings_not_equal
3. string_length

è¾“å…¥ä¸€ä¸ªå­—ç¬¦ä¸², å®ƒå°†ä¸ä½äºåœ°å€`0x402400`çš„å­—ç¬¦ä¸²æ¯”è¾ƒ, ç›¸ç¬¦å³å¯æ‹†é™¤.

å› æ­¤ç­”æ¡ˆä¸º:

> Border relations with Canada have never been better.



### Bomb2

ç‚¸å¼¹2æ¶‰åŠåˆ°ä»¥ä¸‹å‡½æ•°:

1. Phase_2
2. read_six_numbers

è¾“å…¥6ä¸ªæ•°å­—, ç¬¬ä¸€ä¸ªæ˜¯1, å‰©ä¸‹æˆå…¬æ¯”ä¸º2çš„G.P. å³å¯æ‹†é™¤.

å› æ­¤ç­”æ¡ˆä¸º:

> 1 2 4 8 16 32





## Functions

### Main()

```

```



### Phase_1

- è¾“å…¥: ä¸€ä¸ªå­—ç¬¦æŒ‡é’ˆ input
- åŠŸèƒ½: input æŒ‡å‘å¯¹è±¡ä¸ åœ°å€`$0x402400`æŒ‡å‘å¯¹è±¡ç›¸åŒ,ä¸åŒç‚¸
- è°ƒç”¨: strings_not_equal();  explode_bomb();
- è¿”å›: 0

```
Dump of assembler code for function phase_1:
//rdi = *input
    0x0000000000400ee0 <+0>:	sub    $0x8,%rsp        //æ ˆä¸‹è°ƒ8ä½
    0x0000000000400ee4 <+4>:	mov    $0x402400,%esi   //$0x402400 æ”¾å…¥%esi(å‚æ•°2)
    0x0000000000400ee9 <+9>:	callq  0x401338 <strings_not_equal> //è°ƒç”¨strings_not_equal
    0x0000000000400eee <+14>:	test   %eax,%eax       //æ£€æµ‹å‚1å‚2æ˜¯å¦ç›¸åŒ
    0x0000000000400ef0 <+16>:	je     0x400ef7 <phase_1+23>    //0ç›¸åŒ è½¬+23
    0x0000000000400ef2 <+18>:	callq  0x40143a <explode_bomb>  //1ä¸åŒ,ç‚¸
    0x0000000000400ef7 <+23>:	add    $0x8,%rsp    //å‡ºæ ˆ
    0x0000000000400efb <+27>:	retq 

```



### strings_not_equal

- è¾“å…¥: å‚æ•°12 å‡ä¸ºå­—ç¬¦åœ°å€
- åŠŸèƒ½: æ¯”è¾ƒä¸¤ä¸ªæŒ‡å‘å¯¹è±¡é•¿åº¦ä¸å†…å®¹æ˜¯å¦ç›¸åŒ
- è°ƒç”¨: string_length()
- è¿”å›: ç›¸åŒè¿”å›0, ä¸åŒè¿”å›1

```
Dump of assembler code for function strings_not_equal:
/* rdi = *input; esi = $0x402400
    0x0000000000401338 <+0>:	push   %r12
    0x000000000040133a <+2>:	push   %rbp
    0x000000000040133b <+3>:	push   %rbx     //ä»¥ä¸Šä¿å­˜ç¯å¢ƒ
    0x000000000040133c <+4>:	mov    %rdi,%rbx    //rbx = *input
    0x000000000040133f <+7>:	mov    %rsi,%rbp    //rbp = $0x402400(åœ°å€)
    0x0000000000401342 <+10>:	callq  0x40131b <string_length> //è°ƒç”¨string_length, å‚æ•°ä¸å˜
    0x0000000000401347 <+15>:	mov    %eax,%r12d   //r12d(åŒå­—)ä¿å­˜å­—ç¬¦ä¸²é•¿åº¦
    0x000000000040134a <+18>:	mov    %rbp,%rdi    //è®¡ç®—($0x402400)çš„é•¿åº¦
    0x000000000040134d <+21>:	callq  0x40131b <string_length> //($0x402400)é•¿åº¦ä¿å­˜åœ¨rax
    0x0000000000401352 <+26>:	mov    $0x1,%edx    //edx = 1
    0x0000000000401357 <+31>:	cmp    %eax,%r12d   //å­—ç¬¦ä¸²ä¸å¸¸æ•°é•¿åº¦æ¯”è¾ƒ
    0x000000000040135a <+34>:	jne    0x40139b <strings_not_equal+99>  //é•¿åº¦ä¸åŒè½¬99
    0x000000000040135c <+36>:	movzbl (%rbx),%eax  //ä¸²1 -> rax
    0x000000000040135f <+39>:	test   %al,%al
    0x0000000000401361 <+41>:	je     0x401388 <strings_not_equal+80>//å¦‚æœä¸²1ç©º,è½¬80
    0x0000000000401363 <+43>:	cmp    0x0(%rbp),%al        //æ¯”è¾ƒä¸²1ä¸²2
    0x0000000000401366 <+46>:	je     0x401372 <strings_not_equal+58>  //ç›¸ç­‰,è½¬58
    0x0000000000401368 <+48>:	jmp    0x40138f <strings_not_equal+87>  //ä¸ç­‰,è½¬87
    0x000000000040136a <+50>:	cmp    0x0(%rbp),%al    //æ¯”è¾ƒ(å¸¸æ•°)ä¸å­—ç¬¦ä¸²
    0x000000000040136d <+53>:	nopl   (%rax)       //å¥½åƒæ˜¯å¯¹é½ç”¨çš„? æ— æ“ä½œ
    0x0000000000401370 <+56>:	jne    0x401396 <strings_not_equal+94>  //ä¸ç­‰è½¬94
    0x0000000000401372 <+58>:	add    $0x1,%rbx    //å­—ç¬¦ä¸²æŒ‡é’ˆ++
    0x0000000000401376 <+62>:	add    $0x1,%rbp    //å¸¸æ•°åœ°å€æŒ‡é’ˆ++
    0x000000000040137a <+66>:	movzbl (%rbx),%eax  
    0x000000000040137d <+69>:	test   %al,%al      //å¦‚æœå­—ç¬¦ä¸²ä¸ç©º
    0x000000000040137f <+71>:	jne    0x40136a <strings_not_equal+50> //è½¬+50
    0x0000000000401381 <+73>:	mov    $0x0,%edx	//å¦‚æœä¸²1ç©º
    0x0000000000401386 <+78>:	jmp    0x40139b <strings_not_equal+99>
    0x0000000000401388 <+80>:	mov    $0x0,%edx	//ä¸Šæ¥41,ä¸²1ç©º, è¿”å›0
    0x000000000040138d <+85>:	jmp    0x40139b <strings_not_equal+99>
    0x000000000040138f <+87>:	mov    $0x1,%edx    //ä¸Šæ¥48,ä¸²12ä¸ç­‰,è¿”å›1
    0x0000000000401394 <+92>:	jmp    0x40139b <strings_not_equal+99>
    0x0000000000401396 <+94>:	mov    $0x1,%edx    //ä¸Šæ¥94,ä¸²ä¸ç­‰,è¿”å›1
    0x000000000040139b <+99>:	mov    %edx,%eax    //ä¸Šæ¥34,é•¿åº¦ä¸ç­‰,è¿”å›1
    0x000000000040139d <+101>:	pop    %rbx 
    0x000000000040139e <+102>:	pop    %rbp
    0x000000000040139f <+103>:	pop    %r12 //æ¢å¤ç¯å¢ƒ
    0x00000000004013a1 <+105>:	retq   

```

æ³¨:

1. å¼€å¤´ç»“å°¾æœ‰ä¿å­˜ç¯å¢ƒçš„pushä¸popæ“ä½œ

2. r12d æŒ‡12å¯„å­˜å™¨çš„åŒå­—éƒ¨åˆ†, ä¾æ¬¡æ˜¯:r12, r12d, r12w, r12b. dç–‘ä¼¼æŒ‡double word

3. nopl ä¸ºæ— æ“ä½œ, å¯å‚è€ƒ[è¿™é‡Œ](https://exp.newsmth.net/topic/article/9a37ce02c405b2b7ae9558f161f38c38).

4. è¿‡ç¨‹:

   1. å…ˆæ¯”è¾ƒä¸¤ä¸²çš„é•¿åº¦,è‹¥ä¸åŒç›´æ¥è¿”å›1(+34); 
   2. ç„¶åä¸€ä¸ªä¸€ä¸ªbitåœ°æ¯”è¾ƒ, æ¯æ¬¡æ¯”è¾ƒå®Œè·³è½¬å›+50, ç›´åˆ°å…¨éƒ¨æ¯”è¾ƒç»“æŸ, ä¸²ä¸ºç©º,è¿”å›0
   3. å½“æ¯”è¾ƒä¸­é‡åˆ°ä¸²ä¸ç­‰, ç«‹åˆ»é€€å‡º,è¿”å›1

5. ç–‘æƒ‘:

   1. ä¸ºä»€ä¹ˆæ¯æ¬¡æŒ‡é’ˆä»…ä»…æ˜¯è‡ªåŠ ? æ¯æ¬¡æ˜¯å¯¹alæ¯”è¾ƒ(1byte), æŒ‡é’ˆ+4å²‚ä¸ç¾å“‰?

   2. 87,94,99éƒ½æ˜¯å‡ºé”™, è¿”å›1, ä¸ºä»€ä¹ˆä¸åˆå¹¶æˆ1ä¸ª? 

      (çŒœæµ‹:å¯èƒ½æ˜¯ä¼˜åŒ–çº§åˆ«ä¸å¤Ÿ, ç…§é¡¾æˆ‘ä»¬çš„æ™ºåŠ›æ°´å¹³ğŸ˜‚)



### string_length

- è¾“å…¥: å­—ç¬¦æŒ‡é’ˆ
- åŠŸèƒ½: è¿”å›æŒ‡å‘çš„ä¸²çš„é•¿åº¦, ç©ºè¿”å›0
- æ— è°ƒç”¨
- è¿”å›: è¿”å›æŒ‡å‘çš„ä¸²çš„é•¿åº¦, ç©ºè¿”å›0

```
rdi = *input; 
Dump of assembler code for function string_length:
    0x000000000040131b <+0>:	cmpb   $0x0,(%rdi)      
    0x000000000040131e <+3>:	je     0x401332 <string_length+23>  //å¦‚æœinputç©º, è½¬23(è¿”å›0)
    0x0000000000401320 <+5>:	mov    %rdi,%rdx        //rdx = *input
    0x0000000000401323 <+8>:	add    $0x1,%rdx        //rdx ++ æ¯è½®å°†æŒ‡é’ˆ+1 
    0x0000000000401327 <+12>:	mov    %edx,%eax    //eax =rdx
    0x0000000000401329 <+14>:	sub    %edi,%eax    //eax -= edi, å½“å‰æŒ‡é’ˆä¸åŸæŒ‡é’ˆå·®å€¼
    0x000000000040132b <+16>:	cmpb   $0x0,(%rdx)  //æŒ‡é’ˆæŒ‡å‘ä¸0æ¯”è¾ƒ
    0x000000000040132e <+19>:	jne    0x401323 <string_length+8>//å½“æŒ‡å‘éé›¶, è¡¨ç¤ºè¿˜æœªç»“æŸ é€’å½’è°ƒç”¨
    0x0000000000401330 <+21>:	repz retq   //è¿”è¿˜rax å³æœ€åçš„å·®å€¼, ä¸ºæŒ‡é’ˆå‚¨å­˜çš„æ•°æ®çš„é•¿åº¦
    0x0000000000401332 <+23>:	mov    $0x0,%eax    //(ä¸Šæ¥+3) è¿”å›0
    0x0000000000401337 <+28>:	retq  
```



### Phase_2

- è¾“å…¥: *input
- åŠŸèƒ½: ä¸å…­ä¸ªæ•°å­—æ¯”è¾ƒ, ä¸åŒç‚¸
- è°ƒç”¨: read_six_numbers
- è¿”å›: æ— 

```
Dump of assembler code for function phase_2:
//rdi *input
    0x0000000000400efc <+0>:	push   %rbp
    0x0000000000400efd <+1>:	push   %rbx			//ä¿å­˜ç¯å¢ƒ
    0x0000000000400efe <+2>:	sub    $0x28,%rsp   //æ ˆåˆ†28ä½
    0x0000000000400f02 <+6>:	mov    %rsp,%rsi    //æ ˆæŒ‡é’ˆä½œä¸ºç¬¬äºŒä¸ªå‚æ•°
    0x0000000000400f05 <+9>:	callq  0x40145c <read_six_numbers>	//è¯»æ•°åœ¨æ ˆå†…
    0x0000000000400f0a <+14>:	cmpl   $0x1,(%rsp)  //æ ˆé¡¶å…ƒç´ ä¸1æ¯”è¾ƒ
    0x0000000000400f0e <+18>:	je     0x400f30 <phase_2+52>    //ä¸åŒç‚¸, ç›¸åŒè½¬52
    0x0000000000400f10 <+20>:	callq  0x40143a <explode_bomb>
    0x0000000000400f15 <+25>:	jmp    0x400f30 <phase_2+52>
    0x0000000000400f17 <+27>:	mov    -0x4(%rbx),%eax      //eax = æ ˆå…ƒç´ å‰ä¸€ä¸ªå…ƒç´ 
    0x0000000000400f1a <+30>:	add    %eax,%eax            //eax *= 2
    0x0000000000400f1c <+32>:	cmp    %eax,(%rbx)              //rbx(ä¸‹ä¸€ä¸ªå…ƒç´ )ä¸eax(ä¸¤å€çš„ä¸Šä¸€ä¸ªå…ƒç´ )æ¯”è¾ƒ
    0x0000000000400f1e <+34>:	je     0x400f25 <phase_2+41>    //ä¸åŒç‚¸,ç›¸åŒè½¬41
    0x0000000000400f20 <+36>:	callq  0x40143a <explode_bomb>
    0x0000000000400f25 <+41>:	add    $0x4,%rbx            //rbx = æ ˆä¸‹ä¸€ä¸ªå…ƒç´ 
    0x0000000000400f29 <+45>:	cmp    %rbp,%rbx            //rbx ä¸ rbpæ¯”è¾ƒ
    0x0000000000400f2c <+48>:	jne    0x400f17 <phase_2+27>    //ä¸åŒè½¬27,ç»§ç»­è½®å›
    0x0000000000400f2e <+50>:	jmp    0x400f3c <phase_2+64>//ç›¸åŒ,ç¬¬å…­ä¸ªå…ƒç´  è½¬64
    0x0000000000400f30 <+52>:	lea    0x4(%rsp),%rbx       //rbx = ä¸‹ä¸€ä¸ªå…ƒç´ 
    0x0000000000400f35 <+57>:	lea    0x18(%rsp),%rbp      //rbp = æ ˆé¡¶+18(åº”è¯¥æ˜¯ç¬¬å…­ä¸ªå…ƒç´ ,å­˜ç–‘)
    0x0000000000400f3a <+62>:	jmp    0x400f17 <phase_2+27>   //è½¬27
    0x0000000000400f3c <+64>:	add    $0x28,%rsp           //å‡ºæ ˆ28ä½
    0x0000000000400f40 <+68>:	pop    %rbx
    0x0000000000400f41 <+69>:	pop    %rbp             //æ¢å¤ç¯å¢ƒ
    0x0000000000400f42 <+70>:	retq                    //ç»“æŸ
```

æ³¨: 

1. read_six_numbers å‡½æ•°å†…å…¶å®æ²¡çœ‹æ‡‚, ç”±åå­—çŒœæµ‹äº†ä¸€æ³¢
2. lea S DæŒ‡ä»¤, å°†S(ä¸€ä¸ªæœ‰æ•ˆåœ°å€) å¤åˆ¶ç»™D, åç»­å¼•ç”¨(D)ç”¨æ³•ç±»ä¼¼æŒ‡é’ˆ
3. `add    $0x4,%rbx` æŒ‡é’ˆä¸‹ä¸€ä¸ªå…ƒç´ , æ³¨æ„æ ˆæ˜¯å€’è¿‡æ¥å‚¨å­˜çš„
4. å­˜ç–‘:
   1. 57 è¡Œ, `%rbp`åº”è¯¥æ˜¯è¢«èµ‹äº†ç¬¬å…­ä¸ªå‚æ•°çš„å€¼. å¯æ˜¯ä¸ºä»€ä¹ˆæ˜¯+18? ä¸åº”è¯¥æ˜¯+ 20(4*5)å—?



### read_six_numbers

- è¾“å…¥: *input, æ ˆæŒ‡é’ˆ
- åŠŸèƒ½: è¯»å–6ä¸ªæ•°æ®å‚¨å­˜åœ¨æ ˆä¸­
- è°ƒç”¨: __isoc99_sscanf@plt (ç–‘ä¼¼åº“å‡½æ•°?)
- è¿”å›: æ— 

```
Dump of assembler code for function read_six_numbers:
    //rdi *input    rsi æ ˆæŒ‡é’ˆ
    0x000000000040145c <+0>:	sub    $0x18,%rsp       //åˆ†é…18
    0x0000000000401460 <+4>:	mov    %rsi,%rdx        //rdx = åŸæ ˆæŒ‡é’ˆ
    0x0000000000401463 <+7>:	lea    0x4(%rsi),%rcx   //rcx = (åŸæ ˆ2)
    0x0000000000401467 <+11>:	lea    0x14(%rsi),%rax  //rax = (åŸæ ˆ+14)
    0x000000000040146b <+15>:	mov    %rax,0x8(%rsp)   //(æ ˆ+8) = åŸæ ˆ+14
    0x0000000000401470 <+20>:	lea    0x10(%rsi),%rax  //rax = (åŸæ ˆ+10)
    0x0000000000401474 <+24>:	mov    %rax,(%rsp)      //(rsp) = rax = (åŸæ ˆ+10)
    0x0000000000401478 <+28>:	lea    0xc(%rsi),%r9    //r9 = (rsi+c)
    0x000000000040147c <+32>:	lea    0x8(%rsi),%r8    //r8 = (rsi+8)
    0x0000000000401480 <+36>:	mov    $0x4025c3,%esi   //si = $0x4025c3
    0x0000000000401485 <+41>:	mov    $0x0,%eax        //ax = 0
    0x000000000040148a <+46>:	callq  0x400bf0 <__isoc99_sscanf@plt>
    0x000000000040148f <+51>:	cmp    $0x5,%eax        //ç»“æœä¸5æ¯”è¾ƒ
    0x0000000000401492 <+54>:	jg     0x401499 <read_six_numbers+61>//ç»“æœ>5 ä¸ç‚¸
    0x0000000000401494 <+56>:	callq  0x40143a <explode_bomb>
    0x0000000000401499 <+61>:	add    $0x18,%rsp       //æ”¶å›18
    0x000000000040149d <+65>:	retq 
```

å—¯...è™½ç„¶æˆ‘æ²¡æ‡‚ä»–æ¯ä¸€æ­¥åœ¨å¹²ä»€ä¹ˆ, ä¸å¦¨ç¢æˆ‘çŒœå‡ºä»–æ˜¯ç”¨æ¥å¹²å•¥çš„.